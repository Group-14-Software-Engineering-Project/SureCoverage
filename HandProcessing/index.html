<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>SureCoverage Hand Processing</title>
	</head>
	<body>
		<h2>SureCoverage Hand Processing</h2>
		<p id="status">OpenCV.js is loading, please wait...</p>
		<div id="images">
			<div id="imgSrc">
				<p>Your hand:</p>
				<img id="canvasInput" alt="No Image"></img>
				<br>
				<input type="file" id="fileInput" name="file"></input>
			</div>
			<div id="imgRes">
				<p>Areas that need more washing:</p>
				<canvas id="canvasOutput"></canvas>
				<p>Your score: <span id="handScore"></span></p>
			</div>
		</div>
		
		<script type="text/javascript">
			
			let imgElement = document.getElementById('canvasInput');
			let inputElement = document.getElementById('fileInput');
			inputElement.addEventListener('change', (e) => {
				imgElement.src = URL.createObjectURL(e.target.files[0]);
			}, false);
			imgElement.onload = function() {

				// read in the captured image of the hand
				let src = cv.imread('canvasInput');

				// reduce the image of the hand to greyscale
				let grey = new cv.Mat();
				cv.cvtColor(src, grey, cv.COLOR_RGBA2GRAY, 0);

				// this filter removes unwanted contours from the hand interior and raises brightness
				let filtered = new cv.Mat();
				let kernel = cv.Mat.eye(7, 7, cv.CV_32FC1);
				let anchor = new cv.Point(-1, -1);
				cv.filter2D(grey, filtered, cv.CV_8U, kernel, anchor, 0, cv.BORDER_DEFAULT);

				// apply a binary threshold to separate the hand from the background
				let thresholded = new cv.Mat();
				cv.threshold(filtered, thresholded, 250, 255, cv.THRESH_BINARY);
				
				// find the contours from the thresholded image
				let contours = new cv.MatVector();
				let hierarchy = new cv.Mat();
				cv.findContours(thresholded, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_NONE);

				// search for the longest contour since that'll be the hand outline
				let maxArea = 0;
				let maxIndex = 0;
				for (let i = 0; i < contours.size(); i++) {
					let thisArea = cv.contourArea(contours.get(i));
					if (thisArea > maxArea) {
						maxArea = thisArea;
						maxIndex = i;
					}
				}

				// sketch the outline of the hand for use as a mask
				let handOutline = cv.Mat.zeros(src.rows, src.cols, src.type());
				cv.drawContours(handOutline, contours, maxIndex, new cv.Scalar(255,255,255,255), cv.FILLED);

				// apply the hand outline mask to the original image to eliminate the background completely
				let hand = cv.Mat.zeros(src.rows, src.cols, src.type());
				src.copyTo(hand, handOutline);

				cv.imshow('canvasOutput', hand);

			};
		
			function onOpenCvReady() {
				document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
			}
		
		</script>
	
		<script async src="opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
	
	</body>
</html>
